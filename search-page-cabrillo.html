<!DOCTYPE html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js'></script>
    <style>
#internship_filter_group {
display: none;
}
#student_type_filter_group {
display: none;
}
.flex-container {
display: flex;
flex-wrap: wrap;
}
.indented {
margin-left: 2em;
}
        .details {
            display: none;
        }

        iframe {
            display: inline;
            width: 49%;

min-width: 320px;
        }

        #list {
            overflow: scroll;
            height: 480px;
            width: 49%;
min-width:320px;
        }
        h1 {
            text-align: center;
        }
        div.main {
            display: inline-block;
            vertical-align: top;
        }
        #title {
            display: block;
        }
        #filters {
            width: 99%;
        }

        p {
            font-family: sans-serif;
        }
        .organizationCard {
            border: 5px solid #eaeaea;
margin: 6px;
padding: 1em;
        }
        .details {
            display: none;
        }
        /*ul li {
            display: inline;
            list-style-type: none;
            list-style-position: outside;
            padding: 0em 1em 0em 0em;
            margin: 0px;
            text-align: left;
        }
        ul {
            margin: 0px;
            padding: 0px;
            text-align: left;
        }*/
        #zip-filter {
             margin: 0em 0em 0em 5em;
        }
inline-item {
display:inline-block !important;
padding-right: 2em !important;
}
    </style>
    <script type="text/javascript">//THIS SCRIPT IS FOR BUILDING THE LIST
        /*
         * Called on each row in MakeList
        */
        var openDetail = function (index) {
                //var display = document.getElementById('detail' + index).style.display;
                if (document.getElementById('detail' + index).style.display !== 'block') {
                    document.getElementById('detail' + index).style.display = "block";
                } else {
                    document.getElementById('detail' + index).style.display = "none";
                }
            }
        
        function HtmlList(schools_data, addresses) {
            this.schools_data = schools_data;
            this.addresses = addresses;
            /*this.makeRowHtml = function(row) {
                'use strict';
                var str = "";
                str += "<div id='organizationCard'>";
                str += "<a href='organization-details.html'> <h3>" + row["Facility Name"] + "</h3> </a>";
                if (row["Internship Program \n(yes/no)"]) {
                    str += "<p>Internship program: " + row["Internship Program \n(yes/no)"] + "</p>";
                }
                if (row["\nStudent Type:\nHigh school? College? Both?"]) {
                    str += "<p>Student type: " + row["\nStudent Type:\nHigh school? College? Both?"] + "</p>";
                }
                str += "</div>";
                return str;
            }*/
            /*this.makeRowHtml = function(row, index) {
                'use strict';
                var str = "", color = "", color_dot = "";

		color_dot = "<div style=\"background-color: " + colorFromType(row["Type of Organization"]) +"; border-radius: 0.4em; width: 0.8em; height: 0.8em; display: inline-block; margin: 0em 0.5em 0em 0.5em;\"></div>";
                
            
                str += "<div class='organizationCard paragraph'" + "onclick = \"(function() {if (document.getElementById(\'detail" + index + "\').style.display !== 'block') document.getElementById(\'detail" + index + "\').style.display = 'block'; else document.getElementById(\'detail" + index + "\').style.display = 'none'; })()\"" + ">";
                str += "<h3>" + color_dot + row["Facility Name"] + "</h3>";
                str += "<div class=\"details\" id=\"detail" + index + "\">";
                if (row["Contact Information"]) {
                    str += "<p>Contact Information: </p> <div class='indented'>" + htmlWithBreaks(urlsToLinks(row["Contact Information"])) + "</div>";
                }
                if (row["Internship Requirements/Logistics \n(Deadlines, application cycle, internship term etc.)"]) {
                    str += "<p>Internship requirements: </p> " + htmlWithUl(row["Internship Requirements/Logistics \n(Deadlines, application cycle, internship term etc.)"]);
                }
                str += "</div>";
                str += "</div>";
                            
                return str;
            }*/
            this.makeRowHtml = function(row, index) {
                'use strict';
                var str = "", color = "", color_dot = "";

		          color_dot = "<div style=\"background-color: " + colorFromType(row["Type of Organization"]) +"; border-radius: 0.4em; width: 0.8em; height: 0.8em; display: inline-block; margin: 0em 0.5em 0em 0.5em;\"></div>";
                
                str += "<div class='organizationCard paragraph' onclick='(openDetail(" + index + "))' >";
                str += "<h3>" + color_dot + row["Facility Name"] + "</h3>";
                str += "<div class=\"details\" id=\"detail" + index + "\">";
                if (row["Contact Information"]) {
                    str += "<p>Contact Information: </p> <div class='indented'>" + htmlWithBreaks(urlsToLinks(row["Contact Information"])) + "</div>";
                }
                if (row["Internship Requirements/Logistics \n(Deadlines, application cycle, internship term etc.)"]) {
                    str += "<p>Internship requirements: </p> " + htmlWithUl(row["Internship Requirements/Logistics \n(Deadlines, application cycle, internship term etc.)"]);
                }
                str += "</div>";
                str += "</div>";
                            
                return str;
            }
            
            var colorFromType = function (org) {
                'use strict';
                switch (org.toLowerCase()) {
                    case "hospitals":
                        return "orange";
                    case "clinics":
                        return "blue";
                    case "schools":
                        return "green";
                    case "faith-based":
                        return "brown";
                    case "government":
                        return "yellow";
                }
                return "white";
            }
            var htmlWithUl = function(str) {
                var i, out="<ul><li>";
                for (i = 0; i < str.length; i++) {
                    if (str.charCodeAt(i) === 10) out += "</li> <li>";
                    else if (str.charCodeAt(i) !== 45) out+=str.substring(i, i+1);
                }
                out += "</li></ul>"
                return out;
            }
            var htmlWithBreaks = function(str) {
                var i, out="";
                for (i = 0; i < str.length; i++) {
                    if (str.charCodeAt(i) === 10) out += "<br>";
                    else out+=str.substring(i, i+1);
                    }
                return out;
            }
            var getUrlFromString = function(str) {
                'use strict';
                var start, end;
                start = str.indexOf("http");
                if (start === -1) {
                    start = str.indexOf("www");
                }
                if (start === -1) {
                    return "";
                }
                for (end = start; end <= str.length; end += 1) {
                    if (end < str.length && (str.charCodeAt(end) < 33 || str.charCodeAt(end) > 126) ) {
                        break;
                    }
                }
                return str.substring(start, end);
            }
	       var urlsToLinks = function(str) {
		      'use strict';
                    var start, end, url;
                    start = str.indexOf("http");
                    if (start === -1) {
                        start = str.indexOf("www");
                    }
                    if (start === -1)
                    {
                        start = str.indexOf("https");
                    }
                    if (start === -1) {
                        return "";
                    }
                    for (end = start; end <= str.length; end += 1) {
                        if (end < str.length && (str.charCodeAt(end) < 33 || str.charCodeAt(end) > 126) ) {
                            break;
                        }
                    }
		      url = str.substring(start, end);
              return str.substring(0, start) + "<a href = '" + url + "' >" + url + "</a>" + str.substring(end);
           }



            this.makeList = function() {
                'use strict';
                var str = "", i, j;
                for (i = 0; i < addresses.length; i += 1) {
                    /*for (j = 0; j < schools_data[addresses[i].school].length; j += 1) {
                        str += makeRowHtml(schools_data[addresses[i].school][j]);
                    }*/
                    str += this.makeRowHtml(schools_data[addresses[i].school][addresses[i].index], i);
                }
                //console.log(str);
                return str;
            }
            
        }
        /*
            var lineInCell = function(cell, lineIndex) {
                'use strict';
                var i, n = 0, char, output = "";
                //char = output.charAt(0);
                for (i = 0; i <= lineIndex; i += 1) {
                    char = cell.charAt(n);
                    while (char !== 10) {
                        if (i === lineIndex) {
                            output += cell.charAt(n);
                        }
                        n += 1;
                    }
                }
                return output;
            }
            var cellToMultipleLines(str) {
                var output, line = lineInCell(str, 0);
                do {
                    output += line;
                    output += "<br>";
                    line = lineInCell(str, 0)
                } while
            }*/
        /*
        this.makeRowHtml1 = function(row) {
                'use strict';
                var str = "", color = "", color_dot = "";

		color_dot = "<div style=\"background-color: " + colorFromType(row["Type of Organization"]) +"; border-radius: 0.3em; width: 0.6em; height: 0.6em;\"></div>";

                str += "<div class='organizationCard'>";
                str += "<a href=" + getUrlFromString(row["Contact Information"]) + "> " + color_dot + "<h3>" + row["Facility Name"] + "</h3> </a>";
                /*if (row["Internship Program \n(yes/no)"]) {
                    str += "<p>Internship program: " + row["Internship Program \n(yes/no)"] + "</p>";
                }
                if (row["\nStudent Type:\nHigh school? College? Both?"]) {
                    str += "<p>Student type: " + row["\nStudent Type:\nHigh school? College? Both?"] + "</p>";
                }*//*
                str += "<div class=\"details\"";
                if (row["Internship Requirements/Logistics \n(Deadlines, application cycle, internship term etc.)"]) {
                    str += "<p>Internship requirements: " + row["Internship Requirements/Logistics \n(Deadlines, application cycle, internship term etc.)"] + "</p>";
                }
                if (row["Contact Information"]) {
                    str += "<p>Contact Information: " + row["Contact Information"] + "</p>";
                }
                str += "</div>";
                str += "</div>";
                return str;
            }
        function makeRowHtml(row) {
            'use strict';
            var str = "";
            str += "<div id='organizationCard'>";
            str += "<a href='organization-details.html'> <h3>" + row["Facility Name"] + "</h3> </a>";
            if (row["Internship Program \n(yes/no)"]) {
                str += "<p>Internship program: " + row["Internship Program \n(yes/no)"] + "</p>";
            }
            if (row["\nStudent Type:\nHigh school? College? Both?"]) {
                str += "<p>Student type: " + row["\nStudent Type:\nHigh school? College? Both?"] + "</p>";
            }
            str += "</div>";
            return str;
        }
        function makeList(school_elements) {
            'use strict';
            var str = "", i;
            for (i = 0; i < school_elements.length; i += 1) {
                str += makeRowHtml(school_elements[i]);
            }
            return str;
        }
        function makeList(schools_data, addresses) {
            'use strict';
            var str = "", i, j;
            for (i = 0; i < addresses.length; i += 1) {

                str += makeRowHtml(schools_data[addresses[i].school][addresses[i].index]);
            }
            return str;
        }
        function showSchool(school_name) {  //This is for testing only... it is not clear why someone would want to do this otherwise.
            'use strict';
            var retrievedObject = JSON.parse(localStorage.getItem(school_name));
            document.getElementById("list").innerHTML = makeList(retrievedObject);
        }*/
    </script><!--This script is for building the list. DONE-->
    <script type="text/javascript">
        /*global $, jQuery*/
        /*global var, SCHOOLS_LIST*/
        /*global var, address_list*/
        function correctSchool(school_index) {
            'use strict';
            return document.getElementById(SCHOOLS_LIST[school_index].toLowerCase() + "-filter").checked;
        }

        function correctZip(address, schools_data) {
            'use strict';
            var i, cell, zip = document.getElementById("zip-filter").value;
            if (zip.length !== 5) {
                if (zip.length > 0) {
                    document.getElementById("zip-filter").value = "incorrect zip code";
                }
                return true;
            }
            cell = schools_data[address.school][address.index]["Contact Information"];
            for (i = 0; i < cell.length - 5; i += 1) {

                if (cell.substring(i, i + 5) === zip) {
                    return true;
                }
            }
            return false;
        }
        
        function correctInternship(address, schools_data) {
            'use strict';
            var i, cell, yes = document.getElementById("internship-yes-filter").checked, no = document.getElementById("internship-no-filter").checked, no_but = document.getElementById("internship-no-but-filter").checked, other = document.getElementById("internship-other-filter").checked;
            
            cell = schools_data[address.school][address.index]["Internship Program \n(yes/no)"];
            switch (yesNoFromString(cell)) {
                case "yes":
                    return yes;
                case "no":
                    return no;
                case "no, but":
                    return no_but;
                case "other":
                    return other;
            }
        }
        function yesNoFromString(str) {
            'use strict';
            str = " " + str + " ";
            if (str.search(/ yes/i) !== -1) return "yes";
            if (str.search(/ no/i) !== -1) {
                    if (str.search(/ but/i) !== -1) return "no, but";
                    return "no";
            }
            return "other";
        }

        function update() {
            "use strict";

            var i, j, temp, addresses = [], schools_data = [], school_index, list;
            for (i = 0; i < SCHOOLS_LIST.length; i += 1) {
                schools_data.push(JSON.parse(localStorage.getItem(SCHOOLS_LIST[i])));
            }

            for (i = 0; i < address_list.length; i += 1) {
                school_index = address_list[i].school;
                if (correctSchool(school_index) && correctZip(address_list[i], schools_data) && correctInternship(address_list[i], schools_data)) { //Check if the box corresponding with the school is checked
                    addresses.push(address_list[i]);
                }
            }

            //Bubble sort I think
            for (i = 0; i < addresses.length; i += 1) {
                for (j = 0; j < addresses.length - 1 - i; j += 1) {
                    if (addresses[j].relevance > addresses[j + 1].relevance) {
                        temp = addresses[j];
                        addresses[j] = addresses[j + 1];
                        addresses[j + 1] = temp;
                    }
                }
            }
            list = new HtmlList(schools_data, addresses);
            document.getElementById("list").innerHTML = list.makeList();
        }

        $(document).ready(function () {
            "use strict";
            $(".filter, :checkbox").on("click", update);
            $(document).keypress(function (event) {
                if (event.which === 13) {
                    update();
                }
            });
        });
    </script><!--This script is for updating and filtering.-->
    <script type="text/javascript">
       /* function School(name, arr) {
            this.name = name;
            this.data = arr;
            this.
        }*/
    </script><!--This script is for the School type thing-->
    <script type="text/javascript">
        /*global $, jQuery*/
        /*global var, SCHOOLS_LIST*/
        var address_list;

        function setAddressesAll() {
            "use strict";
            var i, j, current = [], addresses = [];
            for (i = 0; i < SCHOOLS_LIST.length; i += 1) {
                current = JSON.parse(localStorage.getItem(SCHOOLS_LIST[i]));
                for (j = 0; j < current.length; j += 1) {
                    addresses.push({
                        school: i,
                        index: j,
                        relevance: 1
                    });
                }
            }
            address_list = addresses;
        }

        function keywordSearch() {
            "use strict";
            var i, j, attribute, k, relevance, current = [], addresses = [], keyword;
            keyword = document.getElementById("search").value;
            //alert(keyword);
            for (i = 0; i < SCHOOLS_LIST.length; i += 1) {
                current = JSON.parse(localStorage.getItem(SCHOOLS_LIST[i]));
                for (j = 0; j < current.length; j += 1) {
                    relevance = 0;

                    for (attribute in current[j]) {
                        if (current[j].hasOwnProperty(attribute)) {
                            for (k = 0; k < current[i][attribute].length - keyword.length; k += 1) {
                                if (current[j][attribute].substring(k, k + keyword.length) === keyword) {
                                    relevance += 1;
                                }
                            }
                            //relevance += (current[j][attribute].match(/is/g) || []).length;
                        }
                    }
                    if (relevance > 0) {
                        addresses.push({
                            school: i,
                            index: j,
                            relevance: relevance
                        });
                    }

                }
            }
            address_list = addresses;
            update();
        }
    </script><!--This is the search related script. It builds the addresslist-->
   <!-- <script type="text/javascript">
        function AddressList
    </script><!--Updater type definition, to replace the previous two scripts. What an AddressList does is store the schools' data (instead of retrieving it from localStorage), store the locations of the desired rows, AND THEN USE THAT INFORMATION TO UPDATE. AddressList is not responsible for the minute inner workings of School objects or Location objects; however, I have not yet formalized the creation of such objects.-->
    <!--
    <script type="text/javascript">//This is the javascript associated with making maps.
        function cellToOneLine(cell) {
            'use strict';
            var i, output = "";
            for (i = 0; i < cell.length; i += 1) {
                if (cell.charCodeAt(i) !== 10) {
                    output += cell[i];
                } else {
                    output += " ";
                }
            }
        }

        function lineInCell(cell, lineIndex) {
            'use strict';
            var i, n = 0, char, output = "";
            char = output.charAt(0);
            for (i = 0; i <= lineIndex; i += 1) {
                char = cell.charAt(n);
                while (char !== 10) {
                    if (i === lineIndex) {
                        output += cell.charAt(n);
                    }
                    n += 1;
                }
            }
            return output;
        }

        function geoCodeGetter(cell) { //I don't understand this code; it's from Stack Overflow.
            'use strict';
            var JSONObject, address, RequestUrl;
            address = lineInCell(cell, 0) + " " + lineInCell(cell, 1);
            RequestUrl = "http://where.yahooapis.com/geocode?location=" + address + "&flags=J&callback=ws_results&output=json";
            JSONObject = new XMLHttpRequest();
            JSONObject.open("GET", RequestUrl, false);
            JSONObject.send(null);
        }

        function addGeoCodes(school_array) {
            'use strict';
            var i, row, data;
            for (i = 0; i < school_array.length; i += 1) {
                row = school_array[i];
                data = geoCodeGetter(row["Contact Information"]);

            }
        }           
    </script><!--This is the javascript associated with making maps.-->
    <script type="text/javascript"> //THIS IS THE MAIN SCRIPT (that gets all the information using Tabletop and sets things in motion, you see)
        const SCHOOLS_LIST = ["CAMS", "Jordan", "Lakewood", "McBride", "Poly"];
        //var publicSpreadSheetUrl = 'https://docs.google.com/spreadsheets/d/1zYOguWMR28cfWa1JMmnXWWKy6TVkPuTaOTv9ho8rY7k/edit?usp=sharing';	//This is the old copy
	var publicSpreadSheetUrl = 'https://docs.google.com/spreadsheets/d/1fvC01qb2I6_0ZUpL8nWAl7StVAopCOlVWBkzd00NOZ0/edit?usp=sharing'; 	//This is the original that is still living and changing
        function init() {
            Tabletop.init( {        //Singleton? //Authkey? //Parameterize?
                key: publicSpreadSheetUrl,
                callback: recordInfo,
                debug: false } )
        }
        function recordInfo(data, tabletop) {
            //console.log(data);
            storeSchool(tabletop, "CAMS");
            storeSchool(tabletop, "Jordan");
            storeSchool(tabletop, "Lakewood"); //The issue here is that in the original doc it got named with a space in it :(
            storeSchool(tabletop, "McBride");
            storeSchool(tabletop, "Poly");
            setAddressesAll();
            update();
        }
        
        function storeSchool(tabletop, school_name) {
            localStorage.setItem(school_name, JSON.stringify(tabletop.sheets(school_name).all()));
        }
        
        
        
        window.addEventListener('DOMContentLoaded', init);
    </script>
    
    <!--TODO 
        1. Put the school processing and accessing methods actually in the School objects, okay? Ah. There are no school objects. But I can make them?
        2. 
-->

</head>



















<body>
<div class="wsite-form-input-container wsite-form-left wsite-form-input-first-name">
	<input id="keyword_search" class="wsite-form-input wsite-input" type="text" placeholder="Keyword"/>
	<label class="wsite-form-sublabel" for="keyword_search">Keyword</label>
<button class="wsite-button wsite-button-small wsite-button-normal" id="search-button" onclick="keywordSearch()">
<span class="wsite-button-inner">Search</span>
</button>
</div>



        <div id="filters" class="main">
            <div class="paragraph"><font color="#000"><strong>School</strong></font></div>
            <!--If these ID's get changed, the world will explode. Don't do it.-->

<div class="paragraph"><font color="#2a2a2a">
<div class="wsite-form-radio-container">

<span class='form-radio-container inline-item' style="display:inline-block !important;
padding-right: 2em !important;"><input type='checkbox' id='cams-filter'/><label for='cams-filter'>CAMS</label></span>

<span class='form-radio-container inline-item' style="display:inline-block !important;
padding-right: 2em !important;"><input type='checkbox' id='jordan-filter' /><label for='jordan-filter'>Jordan</label></span>

<span class='form-radio-container inline-item' style="display:inline-block !important;
padding-right: 2em !important;"><input type='checkbox' id='lakewood-filter' /><label for='lakewood-filter'>Lakewood</label></span>

<span class='form-radio-container inline-item' style="display:inline-block !important;
padding-right: 2em !important;"><input type='checkbox' id='mcbride-filter' /><label for='mcbride-filter'>McBride</label></span>

<span class='form-radio-container inline-item' style="display:inline-block !important;
padding-right: 2em !important;"><input type='checkbox' id='poly-filter' checked='true'/><label for='poly-filter'>Poly</label></span>


  </div>

</font></div>

            <div class="paragraph"><font color="#000"><strong>ZIP code</strong></font></div>

<div class="wsite-form-input-container" >
	<input id="zip-filter" class="wsite-form-input wsite-input" placeholder="Five Digit ZIP" style="margin-left: 0"/>
	<label class="wsite-form-sublabel" for="zip-filter">Five digit ZIP</label>
</div><br>


            <br>


<div class="wsite-form-radio-container" id="internship_filter_group">

<div class="paragraph"><font color="#000"><strong>Is there an internship?</strong></font></div>

<div class="paragraph"><font color="#2a2a2a">

<span class='form-radio-container inline-item' style="display:inline-block !important;
padding-right: 2em !important;"><input type='checkbox' id='internship-yes-filter' checked="checked"/><label for='internship-yes-filter'>Yes</label></span>

<span class='form-radio-container inline-item' style="display:inline-block !important;
padding-right: 2em !important;"><input type='checkbox' id='internship-no-filter' checked="checked"/><label for='internship-no-filter'>No</label></span>

<span class='form-radio-container inline-item' style="display:inline-block !important;
padding-right: 2em !important;"><input type='checkbox' id='internship-no-but-filter' checked="checked"/><label for='internship-no-but-filter'>No, but</label></span>

<span class='form-radio-container inline-item' style="display:inline-block !important;
padding-right: 2em !important;"><input type='checkbox' id='internship-other-filter' checked="checked"/><label for='internship-other-filter'>Other</label></span>

</font></div>


</div>

<div class="wsite-form-radio-container" id="student_type_filter_group">
<div class="paragraph"><font color="#000"><strong>Student type</strong></font></div>
</div>

</div>
<div class="flex-container">
        <iframe src="https://www.google.com/maps/d/u/0/embed?mid=1zTRPn6_XVXGPQPIXfXpVlEUEgnvdtLk_" width="640" height="480" style=""></iframe>
        <div id="list" style=""></div>
</div>
    </body>
</html>